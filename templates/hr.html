<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HR Portal</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/hr.css') }}">
    <style>

    </style>
</head>
<body>
    <header>
        <h1>HR Portal</h1>
        <div class="user-info">
            <img src="{{ url_for('static', filename='images/placeholder-user.png') }}" alt="Фото пользователя" class="user-photo">
            <span class="user-name">{{ current_user['name'] }}</span>
            <a href="{{ url_for('logout') }}" class="button">Выйти</a>
        </div>
    </header>

    <nav>
        <a href="#candidates">Мои кандидаты</a>
        <a href="#reports">Отчеты</a>
        <a href="#tests">Тесты</a>
        <a href="#results">Результаты</a>
        <a href="#office-guide">Путеводитель по офису</a>
        <a href="#notes">Мои заметки</a>
    </nav>

    <div class="container">
        <section id="candidates" class="section">
            <h2>Мои кандидаты</h2>
            {% if candidates %}
            <div class="table-container">
                <table class="candidate-table">
                    <thead>
                        <tr>
                            <th>№</th>
                            <th>Фамилия Имя</th>
                            <th>Телефон</th>
                            <th>Email</th>
                            <th>Вакансия</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for candidate in candidates %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            <td>{{ candidate.user.surname }} {{ candidate.user.name }}</td>
                            <td>{{ candidate.user.phone }}</td>
                            <td>{{ candidate.user.mail }}</td>
                            <td>{{ candidate.status }}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="button primary" onclick="hireCandidate('{{ candidate.user.id }}')">Нанять</button>
                                    <button class="button danger" onclick="rejectCandidate('{{ candidate.user.id }}')">Отклонить</button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p>У вас нет кандидатов</p>
            {% endif %}
        </section>
<!-- Добавьте эту таблицу после существующей таблицы кандидатов -->
<h3>Резюме кандидатов</h3>
<div class="table-container">
    <table class="resume-table">
        <thead>
            <tr>
                <th>№</th>
                <th>Кандидат</th>
                <th>Резюме</th>
                <th>Действия</th>
            </tr>
        </thead>
        <tbody>
            {% for candidate in candidates %}
            <tr>
                <td>{{ loop.index }}</td>
                <td>{{ candidate.user.surname }} {{ candidate.user.name }}</td>
                <td>
                    {% if candidate.resume_filename %}
                        <span class="resume-uploaded">{{ candidate.resume_filename }}</span>
                    {% else %}
                        <span class="resume-missing">Кандидат не загрузил резюме</span>
                    {% endif %}
                </td>
                <td>
                    {% if candidate.resume_filename %}
                        <a href="{{ url_for('download_candidate_resume', candidate_id=candidate.id) }}" 
                           class="button small">Скачать</a>
                    {% else %}
                        <span class="no-resume">Нет резюме</span>
                    {% endif %}
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="4">Нет кандидатов</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
        <section id="resumes" class="section">
            <h2>Прохождение резюмирования кандидатов</h2>
            
            <!-- Проверка существования теста "Резюме" -->
            {% set resume_test = tests|selectattr("name", "equalto", "Резюме")|first %}
            
            <div class="resume-test-info">
                {% if resume_test %}
                {% else %}
                    <p class="warning">Тест "Резюме" не создан. Создайте тест с названием "Резюме" для работы с этой секцией.</p>
                {% endif %}
            </div>
            
            <div class="table-container">
                <table class="resume-table">
                    <thead>
                        <tr>
                            <th>№</th>
                            <th>Кандидат</th>
                            <th>Вакансия</th>
                            <th>Статус резюме</th>
                            <th>Дата заполнения</th>
                            <th>Оценка</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for candidate in candidates %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            <td>{{ candidate.user.surname }} {{ candidate.user.name }}</td>
                            <td>{{ candidate.status }}</td>
                            <td>
                                {% if resume_test %}
                                    {% set resume_assignment = assignments|selectattr("test_id", "equalto", resume_test.id)|selectattr("candidate_id", "equalto", candidate.id)|first %}
                                    
                                    <div class="resume-status">
                                        {% if resume_assignment %}
                                            {% if resume_assignment.completed %}
                                                <div class="resume-status-icon completed" title="Резюме заполнено"></div>
                                                <span>Заполнено</span>
                                            {% else %}
                                                <div class="resume-status-icon pending" title="Ожидает заполнения"></div>
                                                <span>Не заполнено</span>
                                            {% endif %}
                                        {% else %}
                                            <div class="resume-status-icon not-assigned" title="Тест не назначен"></div>
                                            <span>Не назначено</span>
                                        {% endif %}
                                    </div>
                                {% else %}
                                    <div class="resume-status">
                                        <div class="resume-status-icon no-test" title="Тест не создан"></div>
                                        <span>Тест не создан</span>
                                    </div>
                                {% endif %}
                            </td>
                            <td>
                                {% if resume_assignment and resume_assignment.completed and resume_assignment.results %}
                                    {{ resume_assignment.results.completed_at.strftime('%d.%m.%Y %H:%M') }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                {% if resume_assignment and resume_assignment.completed and resume_assignment.results %}
                                    {{ resume_assignment.results.score }} / {{ resume_assignment.results.max_score }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                {% if resume_assignment and resume_assignment.completed and resume_assignment.results %}
                                    <a href="{{ url_for('hr_test_result', result_id=resume_assignment.results.id) }}" class="button small">Просмотр</a>
                                {% elif resume_test and not resume_assignment %}
                                    <button onclick="assignResumeTest('{{ resume_test.id }}', '{{ candidate.id }}')" class="button small">Назначить</button>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="7">Нет кандидатов</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <div class="resume-actions">
                <a href="{{ url_for('compare_candidates') }}" class="button primary">Сравнение кандидатов на вакансию</a>
            </div>
        </section>
        <section id="notes" class="section">
            <h2>Мои заметки</h2>
            <button id="addNoteBtn" class="button primary">Добавить заметку</button>
            
            <div id="notesContainer" class="notes-container">
                <!-- Заметки будут загружаться здесь -->
            </div>
            
            <!-- Модальное окно для редактирования/создания заметки -->
            <div id="noteModal" class="modal">
                <div class="modal-content">
                    <span class="close-modal">&times;</span>
                    <h3 id="modalTitle">Новая заметка</h3>
                    <form id="noteForm">
                        <input type="hidden" id="noteId">
                        <div class="form-group">
                            <label for="noteTitleInput">Заголовок:</label>
                            <input type="text" id="noteTitleInput" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label for="noteContentInput">Содержание:</label>
                            <textarea id="noteContentInput" class="form-textarea" required></textarea>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="button primary">Сохранить</button>
                            <button type="button" class="button secondary" id="cancelNoteBtn">Отмена</button>
                        </div>
                    </form>
                </div>
            </div>
        </section>

        <section id="reports" class="section">
            <h2>Отчеты</h2>
            <div class="table-container">
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>№</th>
                            <th>Название отчета</th>
                            <th>Дата создания</th>
                            <th>Автор</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for report in reports %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            <td>{{ report.name }}</td>
                            <td>{{ report.created_at.strftime('%d.%m.%Y %H:%M') if report.created_at else 'Не указана' }}</td>
                            <td>{{ report.hr.user.surname }} {{ report.hr.user.name }}</td>
                            <td>
                                <a href="{{ url_for('view_report', report_id=report.id) }}" class="button small">Просмотреть</a>
                                {% if not report.is_binary %}
                                    <a href="{{ url_for('export_report', report_id=report.id, format='pdf') }}" class="button small">PDF</a>
                                    <a href="{{ url_for('export_report', report_id=report.id, format='word') }}" class="button small">Word</a>
                                {% else %}
                                    <a href="{{ url_for('download_report', report_id=report.id) }}" class="button small">Скачать</a>
                                {% endif %}
                                <button onclick="deleteReport('{{ report.id }}')" class="button small danger">Удалить</button>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="5">Нет сохраненных отчетов</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <a href="{{ url_for('report_editor') }}" class="button">Редактор отчетов</a>
        </section>

        <section id="tests" class="section">
            <h2>Тесты</h2>
            <a href="{{ url_for('create_test') }}" class="button primary">Добавить тест</a>
            
            <div class="tests-list">
                {% for test in tests %}
                <div class="test-card">
                    <h3>{{ test.name }}</h3>
                    <p>Описание: {{ test.description }}</p>
                    <p>Вопросов: {{ test.questions|length }}</p>
                    <p>Дата создания: {{ test.created_at.strftime('%d.%m.%Y') }}</p>
                    
                    <div class="test-actions">
                        <a href="{{ url_for('edit_test') }}?test_id={{ test.id }}" class="button secondary">Редактировать</a>
                        <button onclick="deleteTest('{{ test.id }}')" class="button danger">Удалить</button>
                    </div>
                    
                    <div class="assign-test-form" style="margin-top: 15px;">
                        <h4>Назначить тест:</h4>
                        <select class="candidate-select" id="candidate_{{ test.id }}" style="width: 100%; padding: 5px; margin-bottom: 10px;">
                            {% for candidate in candidates %}
                            <option value="{{ candidate.id }}">{{ candidate.user.surname }} {{ candidate.user.name }}</option>
                            {% endfor %}
                        </select>
                        <button onclick="assignTest('{{ test.id }}')" class="button primary">Назначить</button>
                    </div>
                </div>
                {% else %}
                <p>У вас нет созданных тестов</p>
                {% endfor %}
            </div>
        </section>

        <section id="results" class="section">
            <h2>Результаты тестов</h2>
            {% if assignments %}
            <div class="table-container">
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Кандидат</th>
                            <th>Тест</th>
                            <th>Статус</th>
                            <th>Результат</th>
                            <th>Дата завершения</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for assignment in assignments %}
                        <tr>
                            <td>{{ assignment.candidate.user.surname }} {{ assignment.candidate.user.name }}</td>
                            <td>{{ assignment.test.name }}</td>
                            <td>
                                {% if assignment.completed %}
                                <span class="status-completed">Пройден</span>
                                {% else %}
                                <span class="status-pending">Не пройден</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if assignment.results %}
                                {{ assignment.results.score }} / {{ assignment.results.max_score }}
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <td>
                                {% if assignment.results %}
                                {{ assignment.results.completed_at.strftime('%d.%m.%Y %H:%M') }}
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <td>
                                {% if assignment.results %}
                                <a href="{{ url_for('hr_test_result', result_id=assignment.results.id) }}" class="button secondary">Просмотр</a>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p>Нет результатов тестирования</p>
            {% endif %}
        </section>
        <section id="job-search" class="section">
            <h2>Мониторинг поиска работы сотрудниками</h2>
            <div class="search-container">
                <select id="companySelect" class="search-input">
                    <option value="Форсайт">Форсайт</option>
                    <option value="Другая компания">Другая компания</option>
                </select>
                <input type="text" id="employeeName" placeholder="Введите имя и фамилию" class="search-input">
                <button id="searchBtn" class="button">Проверить</button>
            </div>
            <div id="searchResults" class="results-container">
                <!-- Здесь будут отображаться результаты -->
            </div>
        </section>
        <section id="candidate-search" class="section">
            <h2>Поиск кандидатов по вакансии</h2>
            <div class="search-container">
                <input type="text" id="vacancySearch" placeholder="Введите название вакансии (например: Java разработчик)" class="search-input">
                <button id="searchCandidatesBtn" class="button">Найти кандидатов</button>
            </div>
            <div id="candidatesResults" class="results-container">
                <!-- Здесь будут отображаться результаты -->
            </div>
        </section>
        <section id="office-guide" class="section">
            <h2>Путеводитель по офису</h2>
            <a href="{{ url_for('maps') }}" class="button primary">Модерация путеводителя</a>
        </section>
    </div>

    <!-- Модальное окно для оценки кандидата -->
    <div id="evaluationModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Оценка кандидата</h2>
            <form id="evaluationForm">
                <input type="hidden" id="candidateId">
                <div class="form-group">
                    <label for="position">Должность:</label>
                    <input type="text" id="position" required>
                </div>
                <div class="form-group">
                    <label for="creativity">Креативность (1-10):</label>
                    <input type="number" id="creativity" min="1" max="10" required>
                </div>
                <div class="form-group">
                    <label for="tech_skills">Технические навыки (1-10):</label>
                    <input type="number" id="tech_skills" min="1" max="10" required>
                </div>
                <div class="form-group">
                    <label for="communication">Коммуникация (1-10):</label>
                    <input type="number" id="communication" min="1" max="10" required>
                </div>
                <div class="form-group">
                    <label for="time_management">Тайм-менеджмент (1-10):</label>
                    <input type="number" id="time_management" min="1" max="10" required>
                </div>
                <div class="form-group">
                    <label for="teamwork">Работа в команде (1-10):</label>
                    <input type="number" id="teamwork" min="1" max="10" required>
                </div>
                <div class="form-actions">
                    <button type="submit" class="button primary">Подтвердить</button>
                    <button type="button" class="button" onclick="closeModal()">Отмена</button>
                </div>
            </form>
        </div>
    </div>

    <footer>
        <p>&copy; {{ current_year }} HR Portal. Все права защищены.</p>
    </footer>
    <script>
        // Функционал заметок
        document.addEventListener('DOMContentLoaded', function() {
    const notesContainer = document.getElementById('notesContainer');
    const addNoteBtn = document.getElementById('addNoteBtn');
    const noteModal = document.getElementById('noteModal');
    const closeModalBtn = document.querySelector('.close-modal');
    const cancelNoteBtn = document.getElementById('cancelNoteBtn');
    const noteForm = document.getElementById('noteForm');
    const noteIdInput = document.getElementById('noteId');
    const noteTitleInput = document.getElementById('noteTitleInput');
    const noteContentInput = document.getElementById('noteContentInput');
    const modalTitle = document.getElementById('modalTitle');
    
    // Загружаем заметки при загрузке страницы
    loadNotes();
    
    // Открываем модальное окно для создания новой заметки
    addNoteBtn.addEventListener('click', () => openModal());
    
    // Закрываем модальное окно
    closeModalBtn.addEventListener('click', closeModal);
    cancelNoteBtn.addEventListener('click', closeModal);
    window.addEventListener('click', (e) => {
        if (e.target === noteModal) closeModal();
    });
    
    // Обработка отправки формы
    noteForm.addEventListener('submit', (e) => {
        e.preventDefault();
        saveNote();
    });
    
    // Функция загрузки заметок
    function loadNotes() {
        fetch('/hr/notes')
            .then(response => response.json())
            .then(data => {
                if (data.notes && data.notes.length > 0) {
                    renderNotes(data.notes);
                } else {
                    notesContainer.innerHTML = '<p>У вас пока нет заметок</p>';
                }
            })
            .catch(error => {
                console.error('Ошибка загрузки заметок:', error);
                notesContainer.innerHTML = '<p class="error">Ошибка загрузки заметок</p>';
            });
    }
    
    // Функция отображения заметок
    function renderNotes(notes) {
        notesContainer.innerHTML = notes.map(note => `
            <div class="note-card" data-id="${note.id}">
                <h4>${note.title}</h4>
                <div class="note-content">${note.content}</div>
                <div class="note-date">${new Date(note.created_at).toLocaleString()}</div>
                <div class="note-actions">
                    <button class="button secondary edit-btn">Редактировать</button>
                    <button class="button danger delete-btn">Удалить</button>
                </div>
            </div>
        `).join('');
        
        // Добавляем обработчики для кнопок редактирования и удаления
        document.querySelectorAll('.edit-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const noteCard = this.closest('.note-card');
                const noteId = noteCard.dataset.id;
                editNote(noteId);
            });
        });
        
        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const noteCard = this.closest('.note-card');
                const noteId = noteCard.dataset.id;
                deleteNote(noteId);
            });
        });
    }
    
    // Функция открытия модального окна
    function openModal(note = null) {
        if (note) {
            modalTitle.textContent = 'Редактировать заметку';
            noteIdInput.value = note.id;
            noteTitleInput.value = note.title;
            noteContentInput.value = note.content;
        } else {
            modalTitle.textContent = 'Новая заметка';
            noteIdInput.value = '';
            noteTitleInput.value = '';
            noteContentInput.value = '';
        }
        noteModal.style.display = 'block';
    }
    
    // Функция закрытия модального окна
    function closeModal() {
        noteModal.style.display = 'none';
    }
    
    // Функция сохранения заметки
    function saveNote() {
        const noteId = noteIdInput.value;
        const title = noteTitleInput.value.trim();
        const content = noteContentInput.value.trim();
        
        if (!title || !content) {
            alert('Заполните все поля');
            return;
        }
        
        const url = noteId ? `/hr/notes/${noteId}` : '/hr/notes';
        const method = noteId ? 'PUT' : 'POST';
        
        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                title: title,
                content: content
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                closeModal();
                loadNotes();
            } else {
                alert(data.error || 'Ошибка при сохранении заметки');
            }
        })
        .catch(error => {
            console.error('Ошибка:', error);
            alert('Произошла ошибка при сохранении заметки');
        });
    }
    
    // Функция редактирования заметки
    function editNote(noteId) {
        fetch('/hr/notes')
            .then(response => response.json())
            .then(data => {
                const note = data.notes.find(n => n.id == noteId);
                if (note) openModal(note);
            })
            .catch(error => {
                console.error('Ошибка:', error);
                alert('Не удалось загрузить заметку для редактирования');
            });
    }
    
    // Функция удаления заметки
    function deleteNote(noteId) {
        if (confirm('Вы уверены, что хотите удалить эту заметку?')) {
            fetch(`/hr/notes/${noteId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadNotes();
                } else {
                    alert(data.error || 'Ошибка при удалении заметки');
                }
            })
            .catch(error => {
                console.error('Ошибка:', error);
                alert('Произошла ошибка при удалении заметки');
            });
        }
    }
});
         // Функция для назначения теста "Резюме"
         function assignResumeTest(testId, candidateId) {
            fetch("{{ url_for('assign_test') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    test_id: testId,
                    candidate_id: candidateId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Тест "Резюме" успешно назначен кандидату!');
                    location.reload();
                } else {
                    alert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Произошла ошибка при назначении теста');
            });
        }

        // Заглушка для функции сравнения кандидатов
        function compareCandidates() {
            alert('Функция сравнения кандидатов будет реализована в ближайшее время');
            // Здесь будет реализация сравнения кандидатов
        }
        
        // Модальное окно
        const modal = document.getElementById("evaluationModal");
        const span = document.getElementsByClassName("close")[0];
        const evaluationForm = document.getElementById("evaluationForm");

        // Функция для открытия модального окна
        async function hireCandidate(candidateId) {
            document.getElementById("candidateId").value = candidateId;
            modal.style.display = "block";
            evaluationForm.reset();
        }

        // Функция для закрытия модального окна
        function closeModal() {
            modal.style.display = "none";
        }

        // Закрытие при клике на крестик
        span.onclick = closeModal;

        // Закрытие при клике вне окна
        window.onclick = function(event) {
            if (event.target == modal) {
                closeModal();
            }
        }

        // Обработка отправки формы оценки
        evaluationForm.onsubmit = async function(e) {
            e.preventDefault();
            
            const candidateId = document.getElementById("candidateId").value;
            const position = document.getElementById("position").value;
            const creativity = document.getElementById("creativity").value;
            const tech_skills = document.getElementById("tech_skills").value;
            const communication = document.getElementById("communication").value;
            const time_management = document.getElementById("time_management").value;
            const teamwork = document.getElementById("teamwork").value;
            
            if (!creativity || !tech_skills || !communication || !time_management || !teamwork || !position) {
                alert("Пожалуйста, заполните все поля!");
                return;
            }
            
            const evaluationData = {
                position: position,
                creativity: creativity,
                tech_skills: tech_skills,
                communication: communication,
                time_management: time_management,
                teamwork: teamwork
            };
            
            try {
                const response = await fetch(`/hire_candidate/${candidateId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(evaluationData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('Кандидат успешно принят в штат!');
                    closeModal();
                    location.reload();
                } else {
                    alert(`Ошибка: ${result.error || 'Неизвестная ошибка'}`);
                }
            } catch (error) {
                console.error('Network error:', error);
                alert('Произошла ошибка соединения с сервером');
            }
        };

        // Функция для отклонения кандидата
        async function rejectCandidate(candidateId) {
            if (confirm('Вы уверены, что хотите отклонить этого кандидата?')) {
                try {
                    const response = await fetch(`/reject_candidate/${candidateId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });
                    
                    if (response.ok) {
                        alert('Кандидат отклонен');
                        location.reload();
                    } else {
                        alert('Ошибка при отклонении кандидата');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Произошла ошибка');
                }
            }
        }

        // Функция для назначения теста
        function assignTest(testId) {
            const candidateId = document.getElementById(`candidate_${testId}`).value;
            
            fetch("{{ url_for('assign_test') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    test_id: testId,
                    candidate_id: candidateId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Тест успешно назначен!');
                    location.reload();
                } else {
                    alert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Произошла ошибка');
            });
        }

        // Функция для удаления теста
        function deleteTest(testId) {
            if (confirm('Вы уверены, что хотите удалить этот тест? Все связанные вопросы и результаты также будут удалены.')) {
                fetch(`/hr/delete_test/${testId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Тест успешно удален');
                        location.reload();
                    } else {
                        alert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Произошла ошибка при удалении теста');
                });
            }
        }
        //Функция для Мониторинга поиска работы сотрудниками

        document.addEventListener('DOMContentLoaded', async () => {
            const searchCandidatesBtn = document.getElementById('searchCandidatesBtn');
            const vacancySearchInput = document.getElementById('vacancySearch');
            const candidatesResults = document.getElementById('candidatesResults');

            // Функция для получения данных через CORS-прокси
            async function fetchWithProxy(url) {
                const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
                try {
                    const response = await fetch(proxyUrl + url, {
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });
                    return await response.json();
                } catch (error) {
                    console.error('Ошибка при запросе:', error);
                    throw error;
                }
            }

            // Парсинг результатов поиска HH.ru
            function parseHHResults(html) {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const items = doc.querySelectorAll('.resume-search-item');
                
                return Array.from(items).slice(0, 5).map(item => {
                    const title = item.querySelector('.resume-search-item__name a')?.textContent.trim() || 'Не указано';
                    const url = item.querySelector('.resume-search-item__name a')?.href || '#';
                    const age = item.querySelector('.resume-search-item__age')?.textContent.trim().replace('Возраст: ', '') || 'Не указан';
                    const salary = item.querySelector('.resume-search-item__compensation')?.textContent.trim() || 'Не указана';
                    const experience = item.querySelector('.resume-search-item__description-content')?.textContent.trim() || 'Не указан';
                    const skills = Array.from(item.querySelectorAll('.bloko-tag__section_text')).map(el => el.textContent.trim()).join(', ') || 'Не указаны';
                    
                    return {
                        title,
                        url: url.startsWith('http') ? url : `https://hh.ru${url}`,
                        age,
                        salary,
                        experience,
                        skills
                    };
                });
            }

            searchCandidatesBtn.addEventListener('click', async () => {
                const vacancyText = vacancySearchInput.value.trim();
                
                if (!vacancyText) {
                    candidatesResults.innerHTML = '<p class="error">Введите название вакансии</p>';
                    return;
                }

                candidatesResults.innerHTML = '<p>Ищем лучших кандидатов на HH.ru...</p>';

                try {
                    // Формируем URL для поиска на HH.ru
                    const searchUrl = `https://hh.ru/search/resume?text=${encodeURIComponent(vacancyText)}&area=1&order_by=relevance`;
                    
                    // Получаем HTML страницы через прокси
                    const response = await fetchWithProxy(searchUrl);
                    const html = response.contents; // Получаем HTML содержимое
                    
                    // Парсим результаты
                    const candidates = parseHHResults(html);
                    
                    if (candidates.length === 0) {
                        candidatesResults.innerHTML = '<p class="error">Не найдено подходящих резюме. Попробуйте изменить параметры поиска.</p>';
                        return;
                    }

                    // Отображаем кандидатов
                    displayCandidates(candidates);
                    
                } catch (error) {
                    candidatesResults.innerHTML = `
                        <p class="error">Ошибка при поиске кандидатов: ${error.message}</p>
                        <p>Попробуйте выполнить поиск напрямую на <a href="https://hh.ru/search/resume?text=${encodeURIComponent(vacancyText)}" target="_blank">HH.ru</a></p>
                    `;
                    console.error(error);
                }
            });

            function displayCandidates(candidates) {
                let html = '<h3>Топ-5 кандидатов:</h3><div class="candidates-list">';
                
                candidates.forEach(candidate => {
                    html += `
                        <div class="candidate-card">
                            <h3>${candidate.title}</h3>
                            <div class="candidate-info">
                                <p><strong>Возраст:</strong> ${candidate.age}</p>
                                <p><strong>Зарплатные ожидания:</strong> ${candidate.salary}</p>
                                <p><strong>Опыт:</strong> ${candidate.experience}</p>
                                <p><strong>Навыки:</strong> ${candidate.skills}</p>
                            </div>
                            <div class="candidate-actions">
                                <a href="${candidate.url}" target="_blank" class="contact-button view-resume">Резюме</a>
                                <a href="https://hh.ru/employer/vacancy_response?resumeHash=${candidate.url.split('/').pop()}" 
                                   target="_blank" 
                                   class="contact-button">Пригласить</a>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                candidatesResults.innerHTML = html;
            }
        });

//функция поиска сотрудников
document.addEventListener('DOMContentLoaded', async () => {
    const CLIENT_ID = 'RV5EKQCQ9TKN9BKAHHHL34IRT89M5F1ONKOSHVR0B81JC470HS4T3T8PMKI75830';
    const CLIENT_SECRET = 'IUEACOR6PMO2P3U398C1GTS6FRN3LVA20JMJAL1E3FM0FNNHFD85MDM9Q4LUOS5T';
    let ACCESS_TOKEN = await getAccessToken();

    // Поиск кандидатов
    const searchCandidatesBtn = document.getElementById('searchCandidatesBtn');
    const vacancySearchInput = document.getElementById('vacancySearch');
    const candidatesResults = document.getElementById('candidatesResults');

    async function getAccessToken() {
        const response = await fetch('https://hh.ru/oauth/token', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: new URLSearchParams({
                grant_type: 'client_credentials',
                client_id: CLIENT_ID,
                client_secret: CLIENT_SECRET
            })
        });
        
        if (!response.ok) {
            throw new Error('Ошибка авторизации в HH API');
        }
        
        return (await response.json()).access_token;
    }

    searchCandidatesBtn.addEventListener('click', async () => {
        const vacancyText = vacancySearchInput.value.trim();
        
        if (!vacancyText) {
            candidatesResults.innerHTML = '<p class="error">Введите название вакансии</p>';
            return;
        }

        candidatesResults.innerHTML = '<p>Ищем лучших кандидатов...</p>';

        try {
            // Обновляем токен если нужно
            if (!ACCESS_TOKEN) {
                ACCESS_TOKEN = await getAccessToken();
            }

            // Ищем вакансии чтобы получить профессиональную область
            const vacancies = await searchVacancies(vacancyText);
            if (vacancies.length === 0) {
                candidatesResults.innerHTML = '<p class="error">Не найдено вакансий по вашему запросу</p>';
                return;
            }

            // Берем профессиональную область из первой вакансии
            const professionalRole = vacancies[0].professional_roles[0].id;
            
            // Ищем резюме по профессиональной области
            const resumes = await searchResumesByRole(professionalRole);
            
            if (resumes.length === 0) {
                candidatesResults.innerHTML = '<p class="error">Не найдено подходящих резюме</p>';
                return;
            }

            // Отображаем топ-5 кандидатов
            displayCandidates(resumes.slice(0, 5));
            
        } catch (error) {
            candidatesResults.innerHTML = `<p class="error">Ошибка: ${error.message}</p>`;
            console.error(error);
        }
    });

    async function searchVacancies(text) {
        const url = `https://api.hh.ru/vacancies?text=${encodeURIComponent(text)}&per_page=1`;
        const response = await fetch(url, {
            headers: {
                'Authorization': `Bearer ${ACCESS_TOKEN}`,
                'User-Agent': 'MyHRApp/1.0'
            }
        });

        if (!response.ok) {
            throw new Error(`Ошибка поиска вакансий: ${response.status}`);
        }

        return (await response.json()).items;
    }

    async function searchResumesByRole(roleId) {
        const url = `https://api.hh.ru/resumes?professional_role=${roleId}&per_page=50&order_by=publication_time`;
        const response = await fetch(url, {
            headers: {
                'Authorization': `Bearer ${ACCESS_TOKEN}`,
                'User-Agent': 'MyHRApp/1.0'
            }
        });

        if (!response.ok) {
            throw new Error(`Ошибка поиска резюме: ${response.status}`);
        }

        const data = await response.json();
        return data.items.map(item => ({
            id: item.id,
            name: item.title,
            age: item.age,
            salary: item.salary ? `${item.salary.amount} ${item.salary.currency}` : 'Не указана',
            experience: getTotalExperience(item.experience),
            skills: item.skills.map(skill => skill.name).join(', '),
            url: `https://hh.ru/resume/${item.id}`
        }));
    }

    function getTotalExperience(experience) {
        if (!experience || experience.length === 0) return 'Нет опыта';
        
        const totalMonths = experience.reduce((sum, exp) => {
            const start = new Date(exp.start_date);
            const end = exp.end_date ? new Date(exp.end_date) : new Date();
            return sum + (end.getMonth() - start.getMonth() + 
                  (end.getFullYear() - start.getFullYear()) * 12);
        }, 0);
        
        const years = Math.floor(totalMonths / 12);
        const months = totalMonths % 12;
        
        return `${years} г. ${months} мес.`;
    }

    function displayCandidates(candidates) {
        let html = '<div class="candidates-list">';
        
        candidates.forEach(candidate => {
            html += `
                <div class="candidate-card">
                    <h3>${candidate.name}</h3>
                    <p>Возраст: ${candidate.age || 'Не указан'}</p>
                    <p>Опыт работы: ${candidate.experience}</p>
                    <p>Зарплатные ожидания: ${candidate.salary}</p>
                    <p>Ключевые навыки: ${candidate.skills || 'Не указаны'}</p>
                    <a href="${candidate.url}" target="_blank" class="button">Посмотреть резюме</a>
                    <button class="contact-button" onclick="contactCandidate('${candidate.id}')">Связаться</button>
                </div>
            `;
        });
        
        html += '</div>';
        candidatesResults.innerHTML = html;
    }

    window.contactCandidate = function(resumeId) {
        alert(`Функция связи с кандидатом ${resumeId} будет реализована позже`);
    };
});
document.addEventListener("DOMContentLoaded", function() {
    // Элементы DOM
    const reportsSection = document.getElementById("reports");
    const reportsTable = reportsSection.querySelector("tbody");
    
    // Создаем кнопку загрузки отчета
    const uploadBtn = document.createElement("button");
    uploadBtn.className = "button primary";
    uploadBtn.textContent = "Загрузить отчет";
    uploadBtn.style.marginRight = "10px";
    uploadBtn.style.marginBottom = "20px";
    
    // Добавляем кнопку перед таблицей
    reportsSection.querySelector(".table-container").prepend(uploadBtn);
    
    // Создаем input для загрузки файла
    const fileInput = document.createElement("input");
    fileInput.type = "file";
    fileInput.accept = ".pdf,.doc,.docx,.xls,.xlsx";
    fileInput.style.display = "none";
    fileInput.id = "reportUploadInput";
    document.body.appendChild(fileInput);
    
    // Обработчик клика по кнопке
    uploadBtn.addEventListener("click", function() {
        fileInput.click();
    });
    
    // Обработчик выбора файла
    fileInput.addEventListener("change", function(e) {
        if (e.target.files.length > 0) {
            const file = e.target.files[0];
            uploadReport(file);
        }
    });
    
 // Функция загрузки отчета
 async function uploadReport(file) {
    // Проверяем размер файла (максимум 10MB)
    if (file.size > 10 * 1024 * 1024) {
        alert("Файл слишком большой. Максимальный размер - 10MB.");
        return;
    }
    
    // Проверяем тип файла
    const validTypes = [
        'application/pdf', 
        'application/msword',
        'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
        'application/vnd.ms-excel',
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        'text/plain',
        'text/csv'
    ];
    
    if (!validTypes.includes(file.type)) {
        alert("Недопустимый формат файла. Разрешены: PDF, Word, Excel, TXT, CSV");
        return;
    }
    
    // Запрашиваем название отчета
    const reportName = prompt("Введите название отчета:");
    if (!reportName) return;
    
    // Создаем форму для отправки
    const formData = new FormData();
    formData.append("report", file);
    formData.append("name", reportName);
    
    // Показываем индикатор загрузки
    uploadBtn.disabled = true;
    uploadBtn.textContent = "Загрузка...";
    
    try {
        const response = await fetch("/upload_report", {
            method: "POST",
            body: formData
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            // Добавляем новый отчет в таблицу
            addReportToTable(result.report);
            alert("Отчет успешно загружен!");
        } else {
            throw new Error(result.error || "Неизвестная ошибка");
        }
    } catch (error) {
        console.error("Ошибка загрузки отчета:", error);
        alert("Ошибка при загрузке отчета: " + error.message);
    } finally {
        // Восстанавливаем кнопку
        uploadBtn.disabled = false;
        uploadBtn.textContent = "Загрузить отчет";
        // Сбрасываем input
        fileInput.value = "";
    }
}

    function addReportToTable(report) {
    const row = document.createElement("tr");
    
    // Номер
    const numCell = document.createElement("td");
    numCell.textContent = reportsTable.rows.length + 1;
    
    // Название
    const nameCell = document.createElement("td");
    nameCell.textContent = report.name;
    
    // Дата
    const dateCell = document.createElement("td");
    const date = new Date(report.created_at);
    dateCell.textContent = date.toLocaleDateString("ru-RU") + " " + date.toLocaleTimeString("ru-RU").slice(0, 5);
    
    // Автор
    const authorCell = document.createElement("td");
    authorCell.textContent = "{{ current_user['name'] }}";
    
    // Действия
    const actionsCell = document.createElement("td");
    
    // Ссылка на просмотр
    const viewLink = document.createElement("a");
    viewLink.href = `/reports/${report.id}`;
    viewLink.className = "button small";
    viewLink.textContent = "Просмотреть";
    
    // Ссылка на скачивание PDF
    const pdfLink = document.createElement("a");
    pdfLink.href = `/reports/${report.id}/export/pdf`;
    pdfLink.className = "button small";
    pdfLink.textContent = "PDF";
    pdfLink.style.marginLeft = "5px";
    
    // Ссылка на скачивание Word
    const wordLink = document.createElement("a");
    wordLink.href = `/reports/${report.id}/export/word`;
    wordLink.className = "button small";
    wordLink.textContent = "Word";
    wordLink.style.marginLeft = "5px";
    
    actionsCell.appendChild(viewLink);
    actionsCell.appendChild(pdfLink);
    actionsCell.appendChild(wordLink);
    
    // Собираем строку
    row.appendChild(numCell);
    row.appendChild(nameCell);
    row.appendChild(dateCell);
    row.appendChild(authorCell);
    row.appendChild(actionsCell);
    
    // Добавляем строку в таблицу
    reportsTable.appendChild(row);
}
    
    // Стили для кнопки загрузки
    const style = document.createElement("style");
    style.textContent = `
        #reportUploadInput {
            display: none;
        }
        .uploading {
            opacity: 0.7;
            pointer-events: none;
        }
    `;
    document.head.appendChild(style);
});
// Кнопка удаления
const deleteBtn = document.createElement("button");
deleteBtn.className = "button small danger";
deleteBtn.textContent = "Удалить";
deleteBtn.style.marginLeft = "5px";
deleteBtn.onclick = function() {
    deleteReport(report.id);
};

actionsCell.appendChild(deleteBtn);
// Функция для удаления отчета
function deleteReport(reportId) {
    if (confirm('Вы уверены, что хотите удалить этот отчет? Это действие нельзя отменить.')) {
        fetch(`/delete_report/${reportId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Отчет успешно удален');
                location.reload();
            } else {
                alert('Ошибка при удалении отчета: ' + (data.error || 'Неизвестная ошибка'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Произошла ошибка при удалении отчета');
        });
    }
}
    </script>
</body>
</html>
